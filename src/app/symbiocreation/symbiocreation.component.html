 <mat-sidenav-container hasBackdrop="false" style="height: calc(100% - 64px)"> <!-- make this occupy total height - toolbar.height -->

    <mat-sidenav #sidenav position="end">
        <router-outlet></router-outlet>
    </mat-sidenav>

    <section fxLayout="row" style="height: 100%;">

        <!-- Main area -->
        <div fxFlex="77" fxFlex.lt-md="70" fxLayout="column">

            <div class="mat-elevation-z3" style="padding: 9px; background-color: white;">
                <h2 class="font-26 gray-900 bolder centered" style="margin-bottom: 0;">

                    <mat-icon class="teal-color-1" 
                            [matTooltip]="symbiocreation?.visibility === 'public' ? 'Pública' : 'Privada'" matTooltipPosition="above"
                            style="position: relative; top: 3px; left: -7px;">
                            {{symbiocreation?.visibility === 'public' ? 'public' : 'lock'}}
                    </mat-icon>

                    <span>{{symbiocreation?.name}}</span>

                    <button mat-icon-button 
                        matTooltip="Ver detalles" matTooltipPosition="above"
                        style="position: relative; top: -4px;" 
                        (click)="openSymbioDetailDialog()">
                        <mat-icon class="gray-600">settings</mat-icon>
                    </button>
                </h2>
                
                <!-- Participant control panel -->
                <div *ngIf="participant">
                    <div>
                        <div class="gray-900 bold" style="padding: 7px 10px; width: 120px; text-align: right;">
                            Mi idea
                        </div>

                        <div fxFlex style="padding: 0 10px;">
                            <div *ngIf="participant.idea">
                                <span class="gray-800">{{participant.idea?.title}}</span>

                                <button mat-button
                                    color="primary"
                                    style="margin-left: 5px;" 
                                    (click)="openIdeaDetailSidenav(getMyNode().id)">
                                    <mat-icon>read_more</mat-icon>
                                    Ver más
                                </button>
                            </div>

                            <div *ngIf="!participant.idea">
                                <button mat-raised-button color="primary"
                                    (click)="openMyIdeaEditDialog()">
                                    Registrar idea
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <div class="gray-900 bold" style="padding: 5px 10px; width: 120px; text-align: right;">
                            Mi grupo<br />
                            <span *ngIf="roleOfLoggedIn === 'ambassador'" class="chip-role small ambassador">Embajador</span>
                        </div>

                        <div fxFlex style="padding: 5px 10px 0;">
                            <div *ngIf="myGroup">
                                <ng-container *ngFor="let a of myAncestry; index as i; last as last">
                                    <span class="chip-ancestry">
                                        Nivel {{i + 1}}: {{a.name}}
                                    </span>
                                    <span *ngIf="!last"> &lt; </span>
                                </ng-container>
                                

                                <button mat-button color="primary"
                                    style="margin-left: 5px;" 
                                    (click)="groupSelectDiv.hidden = false;">
                                    <mat-icon>edit</mat-icon>
                                    Cambiar mi grupo
                                </button>

                                <button *ngIf="roleOfLoggedIn !== 'participant'"
                                    mat-button color="primary"
                                    style="margin-left: 5px;" 
                                    (click)="openNextLevelGroupDialog()">
                                    <mat-icon>upgrade</mat-icon>
                                    Crear siguiente nivel
                                </button>
                            </div>

                            <div #groupSelectDiv hidden style="margin-top: 5px;">
                                <mat-form-field appearance="fill">
                                    <mat-label>Seleccionar grupo</mat-label>
                                    <mat-select [(value)]="idGroupSelected" (selectionChange)="onMyGroupChanged(); groupSelectDiv.hidden = true;">
                                        <mat-option *ngFor="let g of groups" [value]="g.id">{{g.name}}</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <button mat-raised-button color="accent"
                                    style="margin-left: 5px;"
                                    (click)="openNewParentGroupDialog(groupSelectDiv)">
                                    <mat-icon>add</mat-icon>
                                    Crear grupo
                                </button>

                                <button mat-button 
                                    style="margin-left: 5px;"
                                    (click)="groupSelectDiv.hidden = true;">
                                    Cancelar
                                </button>
                            </div>


                            <div *ngIf="!myGroup">
                                Selecciona un grupo existente 

                                <mat-form-field appearance="fill">
                                    <mat-label>Seleccionar grupo</mat-label>
                                    <mat-select [(value)]="idGroupSelected" (selectionChange)="onMyGroupChanged()">
                                        <mat-option *ngFor="let g of groups" [value]="g.id">{{g.name}}</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                o crea un nuevo grupo 
                                <button mat-raised-button color="primary"
                                    (click)="openNewParentGroupDialog()">
                                    <mat-icon>add</mat-icon>
                                    Crear grupo
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                <!--
                <div *ngSwitchCase="'participant'">
                    <div style="text-align: center;" fxLayout="row">
                        <div fxFlex>
                            <mat-form-field appearance="fill" style="width: 75%;">
                                <mat-label>Mi idea</mat-label>
                                <input matInput [value]="participant.idea?.title" readonly>
                                <button mat-icon-button matSuffix matTooltip="Editar idea" [attr.aria-label]="'Edit idea'" (click)="openMyIdeaEditDialog()">
                                    <mat-icon>edit</mat-icon>
                                </button>
                            </mat-form-field>
                        </div>
                        <div fxFlex>
                            <mat-form-field appearance="fill">
                                <mat-label>Mi grupo</mat-label>
                                <mat-select [(value)]="idGroupSelected" [disabled]="disabledGroupSelector" (selectionChange)="onMyGroupChanged()">
                                    <mat-option>Ninguno</mat-option>
                                    <mat-option *ngFor="let g of groups" [value]="g.id">{{g.name}}</mat-option>
                                </mat-select>
                                <button mat-icon-button matSuffix matTooltip="Editar grupo" [attr.aria-label]="'Edit group'" (click)="disabledGroupSelector = false" [disabled]="!disabledGroupSelector">
                                    <mat-icon>edit</mat-icon>
                                </button>
                            </mat-form-field>
                        </div>
                    </div>
                </div> 
                -->

                <div *ngIf="!participant">
                    <p class="centered">Participa de esta simbiocreación!</p>
                    <div style="text-align: center;">
                        <button #btnParticipate mat-raised-button color="accent" (click)="joinSymbiocreation(btnParticipate)">
                            <span>Participar</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div fxFlex>
                <app-graph
                    [data]="symbiocreation?.graph"
                    (parentChanged)="onParentChanged($event)"
                    (nodeDeleted)="onNodeDeleted($event)"
                    (nodeChangedName)="openChangeNodeNameDialog($event)"
                    (nodeChangedIdea)="openEditNodeIdeaDialog($event)">
                </app-graph>
            </div>
        </div>

        <!-- Side area -->
        <div fxFlex="23" fxFlex.lt-md="30" class="mat-elevation-z1">

            <!-- Grupos -->
            <mat-expansion-panel expanded class="mat-elevation-z0">
                <mat-expansion-panel-header class="accent-bg">
                    <mat-panel-title>
                        Grupos
                    </mat-panel-title>
                    <mat-panel-description>
                        {{groups?.length}}
                    </mat-panel-description>
                </mat-expansion-panel-header>

                <mat-list dense>
                    <mat-list-item *ngFor="let g of groups">
                        <span>{{g.name}}</span>
                        <span class="gray-700" style="margin-left: 6px;">· {{g.children.length}} {{g.children.length === 1? 'hijo' : 'hijos'}}</span>
                        
                        <span fxFlex></span>
                        
                        <button mat-icon-button [matMenuTriggerFor]="groupMenu" [matMenuTriggerData]="{node: g}">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                    </mat-list-item>

                </mat-list>

                <!-- Mat menu and submenu -->
                <mat-menu #groupMenu="matMenu">
                    <ng-template matMenuContent let-node="node">
                        <button mat-menu-item (click)="openIdeaDetailSidenav(node.id)">Ver idea</button>
                        <button *ngIf="roleOfLoggedIn === 'moderator' || (roleOfLoggedIn === 'ambassador' && nodeAContainsNodeB(node, getMyNode()))" 
                            mat-menu-item 
                            [matMenuTriggerFor]="groupsSubMenu" 
                            [matMenuTriggerData]="{node: node}">
                            Seleccionar grupo padre
                        </button>
                        <button *ngIf="roleOfLoggedIn === 'moderator' || (roleOfLoggedIn === 'ambassador' && nodeAContainsNodeB(node, getMyNode()))"
                            mat-menu-item 
                            (click)="openChangeNodeNameDialog(node.id)">
                            Cambiar nombre
                        </button>
                        <button *ngIf="roleOfLoggedIn === 'moderator' || (roleOfLoggedIn === 'ambassador' && nodeAContainsNodeB(node, getMyNode()))" 
                            mat-menu-item 
                            (click)="onNodeDeleted(node.id)">
                            Eliminar
                        </button>
                    </ng-template>
                </mat-menu>

                <mat-menu #groupsSubMenu="matMenu">
                    <ng-template matMenuContent let-node="node">
                        <button mat-menu-item *ngFor="let g of filterGroups(groups, node)" (click)="onParentChanged([node.id, g.id])"> <!-- filter because a node cannot be its own parent! -->
                            <span>{{g.name}}</span>
                        </button>
                    </ng-template>
                </mat-menu>
                
            </mat-expansion-panel>

            <!-- Participantes -->
            <mat-expansion-panel expanded class="mat-elevation-z0">
                <mat-expansion-panel-header class="accent-bg">
                    <mat-panel-title>
                        Participantes
                    </mat-panel-title>
                    <mat-panel-description>
                        {{symbiocreation?.participants.length}}
                    </mat-panel-description>
                </mat-expansion-panel-header>
                
                <mat-list dense>
                    <mat-list-item *ngFor="let p of symbiocreation?.participants">
                        
                        <span *ngIf="p.user.firstName && p.user.lastName">{{p.user.firstName}} {{p.user.lastName}}</span>
                        <span *ngIf="!(p.user.firstName && p.user.lastName)">{{p.user.name}}</span>

                        <span *ngIf="p.u_id === participant?.u_id" class="gray-600" style="margin-left: 5px;">(tú)</span>

                        <span *ngIf="p.role === 'moderator'" class="chip-role small moderator" style="margin-left: 6px;">Moderador</span>
                        <span *ngIf="p.role === 'ambassador'" class="chip-role small ambassador" style="margin-left: 6px;">Embajador</span>
                        
                        <span fxFlex></span>
                        
                        <button mat-icon-button 
                            [matMenuTriggerFor]="participantMenu" 
                            [matMenuTriggerData]="{node: getNodeByUserId(p.u_id), participant: p}">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                    </mat-list-item>
                </mat-list>

                <!-- Mat menu and submenu -->
                <mat-menu #participantMenu="matMenu">
                    <ng-template matMenuContent let-node="node" let-p="participant">
                        <button mat-menu-item 
                            (click)="openIdeaDetailSidenav(node.id)">
                            Ver idea
                        </button>

                        <button *ngIf="roleOfLoggedIn === 'moderator' && node.u_id !== participant?.u_id && p.role !== 'moderator'" 
                            mat-menu-item
                            (click)="setAsRole(node.u_id, 'moderator')">
                            Asignar como moderador
                        </button>

                        <button *ngIf="roleOfLoggedIn === 'moderator' && node.u_id !== participant?.u_id && p.role === 'moderator'" 
                            mat-menu-item
                            (click)="setAsRole(node.u_id, 'participant')">
                            Quitar rol de moderador
                        </button>

                        <button *ngIf="roleOfLoggedIn === 'moderator' && node.u_id !== participant?.u_id && p.role !== 'ambassador'" 
                            mat-menu-item
                            (click)="setAsRole(node.u_id, 'ambassador')">
                            Asignar como embajador
                        </button>

                        <button *ngIf="roleOfLoggedIn === 'moderator' && node.u_id !== participant?.u_id && p.role === 'ambassador'" 
                            mat-menu-item
                            (click)="setAsRole(node.u_id, 'participant')">
                            Quitar rol de embajador
                        </button>


                        <button *ngIf="roleOfLoggedIn === 'moderator' || node.u_id === participant?.u_id" 
                            mat-menu-item 
                            [matMenuTriggerFor]="participantsSubMenu" 
                            [matMenuTriggerData]="{node: node}">
                            Seleccionar grupo
                        </button>
                    </ng-template>
                </mat-menu>

                <mat-menu #participantsSubMenu="matMenu">
                    <ng-template matMenuContent let-node="node">
                        <button mat-menu-item *ngFor="let g of groups" (click)="onParentChanged([node.id, g.id])">
                            <span>{{g.name}}</span>
                        </button>
                    </ng-template>
                </mat-menu>
                
            </mat-expansion-panel>
        </div>

    </section>

</mat-sidenav-container>

